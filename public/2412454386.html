<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FoundIT - Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="container py-4">
    <h2 class="mb-3">Admin Panel</h2>
    <p class="text-muted">Manage submissions (delete or edit). This page is hidden and only accessible via direct URL.</p>

    <div id="error" class="alert alert-danger d-none"></div>

    <div class="table-responsive">
      <table class="table table-striped align-middle">
        <thead>
          <tr>
            <th>ID</th>
            <th>Item</th>
            <th>Location</th>
            <th>Contact</th>
            <th>Posted</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
  </div>

  <!-- Edit Modal -->
  <div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
      <form class="modal-content" id="editForm">
        <div class="modal-header">
          <h5 class="modal-title">Edit Item</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="editId" />
          <div class="mb-2">
            <label class="form-label">Item name</label>
            <input class="form-control" id="editItemName" required />
          </div>
          <div class="mb-2">
            <label class="form-label">Description</label>
            <textarea class="form-control" id="editDescription" rows="3" required></textarea>
          </div>
          <div class="mb-2">
            <label class="form-label">Location</label>
            <input class="form-control" id="editLocation" required />
          </div>
          <div class="mb-2">
            <label class="form-label">Name</label>
            <input class="form-control" id="editName" required />
          </div>
          <div class="mb-2">
            <label class="form-label">Email</label>
            <input type="email" class="form-control" id="editEmail" required />
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-primary" type="submit">Save changes</button>
        </div>
      </form>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const rows = document.getElementById('rows');
    const errorBox = document.getElementById('error');

    let allItems = [];
    let editModal;

    async function loadItems() {
      try {
        const res = await fetch('/api/items');
        const items = await res.json();
        allItems = items;
        render(items);
      } catch (err) {
        showError('Failed to load items.');
      }
    }

    function render(items) {
      rows.innerHTML = items.map(item => `
        <tr>
          <td>${item.id}</td>
          <td>
            <div class="fw-semibold">${item.itemName}</div>
            <div class="text-muted small">${item.description}</div>
          </td>
          <td>${item.location}</td>
          <td>${item.name} â€” ${item.email}</td>
          <td>${new Date(item.createdAt).toLocaleString()}</td>
          <td class="text-nowrap">
            <button class="btn btn-sm btn-secondary me-2" onclick="beginEdit(${item.id})">Edit</button>
            <button class="btn btn-sm btn-danger" onclick="deleteItem(${item.id})">Delete</button>
          </td>
        </tr>
      `).join('');
    }

    function showError(msg) {
      errorBox.textContent = msg;
      errorBox.classList.remove('d-none');
      setTimeout(() => errorBox.classList.add('d-none'), 2000);
    }

    function beginEdit(id) {
      const item = allItems.find(i => i.id === id);
      if (!item) return;

      document.getElementById('editId').value = item.id;
      document.getElementById('editItemName').value = item.itemName;
      document.getElementById('editDescription').value = item.description;
      document.getElementById('editLocation').value = item.location;
      document.getElementById('editName').value = item.name;
      document.getElementById('editEmail').value = item.email;

      if (!editModal) editModal = new bootstrap.Modal(document.getElementById('editModal'));
      editModal.show();
    }

    document.getElementById('editForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = Number(document.getElementById('editId').value);
      const payload = {
        itemName: document.getElementById('editItemName').value.trim(),
        description: document.getElementById('editDescription').value.trim(),
        location: document.getElementById('editLocation').value.trim(),
        name: document.getElementById('editName').value.trim(),
        email: document.getElementById('editEmail').value.trim()
      };

      try {
        const res = await fetch('/api/items/' + id, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (res.ok && data.success) {
          // Update local array and re-render
          const idx = allItems.findIndex(i => i.id === id);
          if (idx !== -1) allItems[idx] = { ...allItems[idx], ...payload };
          render(allItems);
          editModal.hide();
        } else {
          showError(data.error || 'Failed to update item.');
        }
      } catch (err) {
        showError('Network error.');
      }
    });

    async function deleteItem(id) {
      const ok = confirm('Delete this item? This cannot be undone.');
      if (!ok) return;
      try {
        const res = await fetch('/api/items/' + id, { method: 'DELETE' });
        const data = await res.json();
        if (res.ok && data.success) {
          allItems = allItems.filter(i => i.id !== id);
          render(allItems);
        } else {
          showError(data.error || 'Failed to delete item.');
        }
      } catch (err) {
        showError('Network error.');
      }
    }

    loadItems();
  </script>
</body>
</html>
